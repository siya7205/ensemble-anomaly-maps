<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>NGL Anomaly Viewer</title>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#ddd;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #ui{position:fixed;left:10px;top:10px;z-index:10}
    #viewport{position:absolute;left:0;top:0;right:0;bottom:0}
    button, input[type=range]{margin-right:8px}
    .dot{display:inline-block;width:12px;height:12px;border-radius:6px;background:#fff;vertical-align:middle}
  </style>
  <script src="https://unpkg.com/ngl@latest/dist/ngl.js"></script>
</head>
<body>
  <div id="ui">
    <div>Color: <b>B-factor</b> (your anomaly).</div>
    <div style="margin-top:6px;">
      <button id="playBtn">Play</button>
      <button id="pauseBtn">Pause</button>
      &nbsp; Frame: <span id="fidx">–</span>/<span id="fmax">–</span>
      <input id="slider" type="range" min="0" max="0" step="1" value="0" style="width:240px;vertical-align:middle;">
      <span class="dot" id="playingDot" title="playing" style="margin-left:6px;background:#888"></span>
    </div>
    <div style="margin-top:6px;">
      <span id="pickInfo">Anomaly: –</span>
    </div>
  </div>
  <div id="viewport"></div>

  <script>
    // ---- params ----
    const qp = new URLSearchParams(location.search);
    const pdbURL = qp.get('src') || './data/multi_model_anomaly.pdb';  // Adjust path if needed
    const tsURL  = qp.get('ts')  || './data/anomaly_timeseries.json';  // Adjust path if needed

    const stage = new NGL.Stage("viewport", { sampleLevel: 1, backgroundColor: "black" });
    window.addEventListener("resize", () => stage.handleResize());

    let comp, traj, nFrames = 0, playing = false, playTimer = null;
    let timeseries = null;

    function setPlaying(p){
      playing = p;
      document.getElementById('playingDot').style.background = p ? '#1ad' : '#888';
      if (playTimer) { clearInterval(playTimer); playTimer = null; }
      if (p){
        playTimer = setInterval(()=> {
          const i = (traj.player.frame + 1) % nFrames;
          traj.player.gotoFrame(i);
          updateUI();
        }, 80);
      }
    }

    function updateUI(){
      const i = traj ? traj.player.frame : 0;
      document.getElementById('fidx').textContent = nFrames ? (i+1) : '–';
      document.getElementById('fmax').textContent = nFrames || '–';
      const slider = document.getElementById('slider');
      slider.max = nFrames ? (nFrames-1) : 0;
      if (Number(slider.value) !== i) slider.value = i;
    }

    // Load timeseries (optional)
    fetch(tsURL).then(r => r.ok ? r.json() : null).then(js => { timeseries = js; }).catch(()=>{});

    // ---- Load multi-model PDB as trajectory ----
    stage.loadFile(pdbURL, { ext: "pdb", asTrajectory: true }).then((o) => {
      comp = o;
      comp.addRepresentation("cartoon", { color: "bfactor", roughness: 0.3, metalness: 0.0, opacity: 1.0 });
      comp.autoView();

      traj = comp.trajectory;
      nFrames = traj.frameCount;   // Update frame count
      updateUI();

      // Picking -> show residue + anomaly
      stage.signals.clicked.add((p)=>{
        if (!p || !p.atom || !timeseries) { document.getElementById('pickInfo').textContent = 'Anomaly: –'; return; }
        const atom = p.atom;
        const frame = traj.player.frame;
        const resid = atom.resno;
        let score = null;
        if (timeseries.per_frame && timeseries.per_frame[frame] && timeseries.per_frame[frame][resid]){
          score = timeseries.per_frame[frame][resid];
        }
        const txt = `Residue ${atom.resname} ${resid}` + (score!=null ? ` | anomaly=${score.toFixed(3)}` : '');
        document.getElementById('pickInfo').textContent = txt || 'Anomaly: –';
      });

    }).catch(err => {
      console.error("Error loading multi-model PDB: ", err);
      alert("Couldn't load multi-model PDB. Trying a single frame for debugging…");
      stage.loadFile(pdbURL, { ext: "pdb" }).then(o=>{
        o.addRepresentation("cartoon", { color: "bfactor" });
        o.autoView();
      });
    });

    // UI wiring
    document.getElementById('playBtn').onclick = ()=> setPlaying(true);
    document.getElementById('pauseBtn').onclick = ()=> setPlaying(false);
    document.getElementById('slider').oninput = (e)=>{
      if (!traj) return;
      const i = Number(e.target.value);
      traj.player.gotoFrame(i);
      updateUI();
    };

    window.addEventListener('keydown', (e)=>{
      if (e.code === 'Space' || e.code === 'Enter'){ e.preventDefault(); setPlaying(!playing); }
      if (!traj) return;
      if (e.key === 'ArrowRight'){ traj.player.gotoFrame((traj.player.frame+1)%nFrames); updateUI(); }
      if (e.key === 'ArrowLeft'){ traj.player.gotoFrame((traj.player.frame-1+nFrames)%nFrames); updateUI(); }
    });
  </script>
</body>
</html>
