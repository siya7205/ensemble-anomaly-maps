<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ensemble Anomaly Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif; margin: 16px; }
    h1 { margin: 0 0 8px; }
    .row { display: flex; gap: 16px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; background: #fff; }
    .left { flex: 1 1 40%; min-height: 420px; }
    .right { flex: 1 1 60%; min-height: 420px; }
    iframe { width: 100%; height: 420px; border: 0; background: #fafafa; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #eee; text-align: left; }
    .muted { color: #666; font-size: 14px; }
    button { padding: 6px 12px; border: 1px solid #ccc; border-radius: 6px; background: #f4f4f4; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: default; }
  </style>
</head>
<body>
  <h1>Ensemble Anomaly Maps</h1>
  <div class="muted">Upload a .pdb → compute φ/ψ → score anomalies → view top residues + φ/ψ plot.</div>

  <div class="row" style="margin-top:16px;">
    <div class="card left">
      <h3>1) Upload &amp; score</h3>
      <input type="file" id="pdb" accept=".pdb" />
      <button id="runBtn">Run analysis</button>
      <div id="status" class="muted" style="margin-top:8px;">Ready.</div>
    </div>

    <div class="card right">
      <h3>2) φ/ψ viewer</h3>
      <iframe id="rama" title="Ramachandran viewer" src=""></iframe>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h3>Top anomalous residues</h3>
    <table id="tbl">
      <thead>
        <tr>
          <th>Resid</th>
          <th>Mean IF (↓ = more anomalous)</th>
          <th>% Disallowed</th>
          <th>Frames</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
<h2>Local Ops (domain rules) – Top residues</h2>
<button id="loadLocalOps">Load local-ops</button>
<p id="localOpsPath"></p>
<table>
  <thead><tr>
    <th>resid</th><th>resname</th><th>score_med</th><th>%disallowed</th><th>frames</th>
  </tr></thead>
  <tbody id="localOpsBody"></tbody>
</table>
  <script>
    const runBtn = document.getElementById('runBtn');
    const fileInp = document.getElementById('pdb');
    const statusEl = document.getElementById('status');
    const rama = document.getElementById('rama');
    const tbody = document.querySelector('#tbl tbody');

    async function fetchTop() {
      try {
        const r = await fetch('/api/top_anomalies');
        if (!r.ok) return;
        const data = await r.json();
        tbody.innerHTML = '';
        for (const row of data) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.resid ?? ''}</td>
            <td>${(row.mean_if ?? '').toFixed ? row.mean_if.toFixed(6) : row.mean_if}</td>
            <td>${row.pct_disallowed ?? ''}</td>
            <td>${row.n_frames ?? ''}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function runAnalysis() {
      const f = fileInp.files?.[0];
      if (!f) {
        statusEl.textContent = 'Please choose a .pdb first.';
        return;
      }
      runBtn.disabled = true;
      statusEl.textContent = 'Uploading and scoring… (watch your Flask terminal for /api/score_pdb 200)';

      try {
        const fd = new FormData();
        fd.append('file', f, f.name);
        const r = await fetch('/api/score_pdb', { method: 'POST', body: fd });
        const js = await r.json();
        if (!r.ok || js.ok === false) {
          statusEl.textContent = 'Error: ' + (js.error || r.statusText);
          console.error(js);
        } else {
          statusEl.textContent = 'Done.';
          // refresh plot and table
          rama.src = '/rama?ts=' + Date.now(); // cache‑bust
          fetchTop();
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Network/JS error — see console.';
      } finally {
        runBtn.disabled = false;
      }
    }

    runBtn.addEventListener('click', runAnalysis);

    // On load: try to show existing plot + table if present
    rama.src = '/rama?ts=' + Date.now();
    fetchTop();
  </script>
</body>
</html>
