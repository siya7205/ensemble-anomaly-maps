<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>NGL Anomaly B-factor Viewer</title>
  <script src="https://unpkg.com/ngl@2.0.0-dev.38/dist/ngl.js"></script>
  <style>
    html,body,#viewport{width:100%;height:100%;margin:0;overflow:hidden;background:#111}
    #hud{position:absolute;top:8px;left:8px;color:#ddd;font:14px system-ui;background:rgba(0,0,0,.35);padding:6px 8px;border-radius:4px}
  </style>
</head>
<body>
<div id="viewport"></div>
<div id="hud">Color: <b>B-factor</b> (your anomaly score). Space/Enter = play/pause</div>
<script>
(async function(){
  const stage = new NGL.Stage("viewport", { backgroundColor: "black" });
  window.addEventListener("resize",()=>stage.handleResize(), false);

  async function loadMulti(url){
    const comp = await stage.loadFile(url, {
      ext: "pdb",
      firstModelOnly: false,      // <-- IMPORTANT
      asTrajectory: true          // <-- IMPORTANT (force building a traj)
    });
    comp.addRepresentation("cartoon", { colorScheme: "bfactor", opacity: 1.0 });
    comp.autoView();

    const traj = comp.traj;
    if (!traj || traj.frameCount < 2) {
      throw new Error("No multi-model trajectory detected.");
    }

    let playing = false;
    const speed = 30; // frames per second
    let handle = null;

    function play(){ if(playing) return;
      playing = true;
      let f = 0;
      handle = setInterval(()=>{
        f = (f + 1) % traj.frameCount;
        traj.setFrame(f);
        stage.requestRender();
      }, 1000/speed);
    }
    function stop(){ if(handle){ clearInterval(handle); handle=null; } playing=false; }

    window.addEventListener("keydown", (ev)=>{
      if (ev.code === "Space" || ev.code === "Enter") {
        playing ? stop() : play();
      }
    });

    return comp;
  }

  async function loadSingle(url){
    const comp = await stage.loadFile(url, { ext:"pdb" });
    comp.addRepresentation("cartoon", { colorScheme: "bfactor" });
    comp.autoView();
  }

  const multiUrl  = "/data/multi_model_anomaly.pdb";
  const singleUrl = "/data/colored_frames/colored_frame_00000.pdb";

  try {
    await loadMulti(multiUrl);
  } catch (e) {
    alert("Couldn't load multi-model PDB. Trying a single frame for debugging...");
    await loadSingle(singleUrl);
  }
})();
</script>
</body>
</html>
