<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>NGL Anomaly Viewer</title>
  <style>
    html,body,#viewport { margin:0; height:100%; width:100%; overflow:hidden; background:#000; }
    #hud { position:absolute; top:10px; left:10px; color:#ddd; font:14px system-ui; z-index:10 }
    #hud input[type=range]{ width:320px; vertical-align:middle; }
    #hud button{ margin-right:6px; }
  </style>
  <script src="https://unpkg.com/ngl@2.0.0-dev.39/dist/ngl.js"></script>
</head>
<body>
<div id="viewport"></div>
<div id="hud">
  <button id="play">▶︎</button>
  <input id="slider" type="range" min="1" max="1" value="1">
  <span id="label">Frame 1/1</span>
  <div style="margin-top:6px;">Color: <b>B-factor</b> (your anomaly score). Space/Enter = play/pause</div>
</div>

<script>
(async function(){
  const stage = new NGL.Stage("viewport", { backgroundColor: "black" });
  window.addEventListener("resize", ()=> stage.handleResize());

  // IMPORTANT: path must start with /data, not /tools/data
  const multiUrl  = "/data/multi_model_anomaly.pdb";
  const fallback0 = "/data/colored_frames/colored_frame_00000.pdb";

  let comp, nModels = 1, current = 1, timer = null;

  function setFrame(i){
    if(!comp) return;
    current = ((i-1+nModels)%nModels)+1;
    comp.setSelection(`model ${current}`);
    slider.value = current;
    label.textContent = `Frame ${current}/${nModels}`;
  }

  const playBtn = document.getElementById("play");
  const slider  = document.getElementById("slider");
  const label   = document.getElementById("label");
  playBtn.onclick = ()=>{
    if(timer){ clearInterval(timer); timer=null; playBtn.textContent="▶︎"; }
    else { playBtn.textContent="⏸"; timer=setInterval(()=> setFrame(current+1), 200); }
  };
  slider.oninput = e => setFrame(parseInt(e.target.value,10));
  window.addEventListener("keydown", e=>{
    if(e.code==="Space"||e.code==="Enter"){ playBtn.click(); e.preventDefault(); }
    if(e.code==="ArrowRight") setFrame(current+1);
    if(e.code==="ArrowLeft")  setFrame(current-1);
  });

  async function loadPDB(url){
    const o = await stage.loadFile(url, { ext:"pdb" });
    o.addRepresentation("cartoon", { color:"bfactor", quality:"auto" });
    o.autoView();
    return o;
  }

  try{
    comp = await loadPDB(multiUrl);
    nModels = comp.structure.models.length || 1;
    slider.max = nModels;
    setFrame(1);
  }catch(err){
    alert("Couldn't load multi-model PDB. Trying a single frame for debugging...");
    comp = await loadPDB(fallback0);
    nModels = 1; slider.max = 1; setFrame(1);
  }
})();
</script>
</body>
</html>
